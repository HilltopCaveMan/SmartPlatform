@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@Html.Partial("_HeaderPartial")
@model System.Collections.Generic.IList<GModel.RoleRight.MenuInfo>
<div class="moitorContent" id="moitorContent">
    <div id="contentwrapper11" class="contentwrapper withrightpanel">
        <div class="subcontent chatcontent">
            <div id="MapContainer">
                <div id="GoogleMap" onclick="GoogleMap()">谷歌地图</div>
                <div id="BaiDuMap" onclick="BaiDuMap()">百度地图</div>
            </div>
            <div id="chatmessage" class="chatmessage radius2" style="padding:5px;">
                <div id="BDMap" style="height:100%;width:100%;"></div><!--chatmessageinner-->
                <div class="full" id="fullscreen">全屏</div>
                @*<div  class="Location" id="Location">测距</div>*@
                <div class="Location"><input type="checkbox" name="check1" id="Location" />测距</div>
                <div class="mappanel-btn">
                    <input id="mointerCar" type="checkbox" name="check1" />实时监控
                </div>
                <div class="timeout" id="timeReturn"></div>
                <div class="showPanelBtn allcar" id="AllCar">实时车辆</div>
                <div class="showPanelBtn caic" id="showPanelCX">拆卸报警<span class="noft-red"></span></div>
                <div class="showPanelBtn yuq" id="showPanelYQ">逾期报警<span class="noft-red"></span></div>
                <div class="showPanelBtn duandian" id="showPanelDD">断电报警<span class="noft-red"></span></div>
                <div class="showPanelBtn quyu" id="showPanelQY">区域报警<span class="noft-red"></span></div>
                <div class="panelWrap" id="panelWrap">
                    <div style="width:20px;height:200px;margin:-100px 0 0 -10px;color:#999;position:absolute;opacity:0.5;top:50%;left:50%;" id="showOverlayInfo">此处用于展示报警车辆信息</div>
                    <div id="panel" style="position:absolute;"></div>
                </div>
                <a class="intoList down" href="#"></a>
            </div><!--chatmessage-->
        </div><!--subcontent-->
    </div><!--contentwrapper-->
    <div class="rightpanel" id="rightpanel">
        <div class="rightpanelinner">
            <div class="widgetbox uncollapsible">
                <div class="widgetoptions">
                    <input type="text" class="easyui-combotree" id="DeptSel" panelheight="400" style="width:100%;height:30px" />
                </div>
                <div class="widgetcontent userlistwidget nopadding">
                    <div class="widgetcheck">
                        <input id="ShowAll" type="checkbox" name="check2" /> 显示子企业的车辆
                    </div>
                    <div class="easyui-tabs" id="CarStatu">
                        <div title="全部">
                            <div class="box-scroll" id="box-scroll">
                                <ul id="MonitorList" class="contactlist"></ul>
                            </div>
                        </div>
                        @*<div title="在线">
                                <div class="box-scroll" style="margin-top:10px;">
                                    <ul id="MonitorList1" class="contactlist"></ul>
                                </div>
                            </div>*@
                        <div title="离线">
                            <div class="box-scroll" id="box-scroll2">
                                <ul id="MonitorList2" class="contactlist"></ul>
                            </div>
                        </div>
                    </div>
                    <a id="car_count" class="more" href="#"></a>
                    @*<a class="more" href="#" onclick="AddShowCar()">查看更多车辆&nbsp;↓</a>*@
                </div><!--widgetcontent-->
            </div><!--widgetbox-->
        </div><!--rightpanelinner-->
    </div><!--rightpanel-->
</div>
<div id="contentwrapper" class="contentwrapper">
    <div class="tableoptions">
        <button class="deletebutton radius3" id="DownLoadData" title="table2">导出数据</button> &nbsp;
    </div><!--tableoptions-->
    <table cellpadding="0" cellspacing="0" border="0" class="stdtable" id="dyntable">
        <colgroup>
            <col class="con0" />
            <col class="con1" />
            <col class="con0" />
            <col class="con1" />
            <col class="con0" />
            <col class="con1" />
            <col class="con0" />
            <col class="con1" />
            <col class="con0" />
            <col class="con1" />
        </colgroup>
        <thead>
            <tr>
                <th class="head0">回传时间</th>
                <th class="head1">车牌号</th>
                <th class="head0">终端编号</th>
                <th class="head1">终端状态</th>
                <th class="head0">定位方式</th>
                <th class="head1">当前位置</th>
                <th class="head0">SIM卡号</th>
                <th class="head0">所属组织</th>
                <th class="head1">回传次数</th>
            </tr>
        </thead>
        <tbody @*id="ListData"*@></tbody>
    </table>
</div>
<div id="target"></div>
@Html.Partial("_FooterPartial")
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=3xyzXPzwlGKFZWULrsKdioWb"></script>
<link href="~/assets/BMapLib/DrawingManager_min.css" rel="stylesheet" />
<link href="~/assets/BMapLib/SearchInfoWindow_min.css" rel="stylesheet" />
<script src="~/assets/BMapLib/SearchInfoWindow_min.js"></script>
<script src="~/assets/BMapLib/DrawingManager.js"></script>
<script src="~/assets/javascripts/DrawingManager_min.js"></script>
<script src="~/assets/javascripts/DistanceTool_min.js"></script>
<script src="~/assets/javascripts/TextIconOverlay_min.js"></script>
<script src="~/assets/javascripts/MarkerClusterer_min.js"></script>

<script src="~/assets/javascripts/Index.js"></script>

<script type="text/javascript">

    var RowNumber = 1;
    var SearchFlag = 0;
    var SearchValue = "";
    var SearchName = "";
    var CKXQ = '@ViewBag.CKXQ';
    var CKGJ = '@ViewBag.CKGJ';
    var FSML = '@ViewBag.FSML';
    //当前页面类型（AllCar:实时车辆监控,CXWarning:拆卸报警,DDWarning:断电报警）
    var MapType = "AllCar";

    var countdown;
    var count;
    //车辆监控
    @*var CLJK= '@ViewBag.CLJK';*@
    //终端监控
    var ZDJK = '@ViewBag.ZDJK';
    //统计报表
    @*var TJBB= '@ViewBag.TJBB';*@
    //系统管理按钮
    @*var XTGLAN= '@ViewBag.XTGLAN';*@

    var MonitorMap = {};
    MonitorMap.markers = [];

    var data = null;

    var t;
    var CarTable;
    var isPanelShow = false;
    var innerHeight;

    var target = $('#target');

    // 百度地图API功能
    var BmarkerClusterer = null;
    var map = new BMap.Map("BDMap");
    MonitorMap.map = map;

    var userAgent = navigator.userAgent;
    if (userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1 && !isOpera) {
        map.centerAndZoom(new BMap.Point(116.404, 39.915), 11);
    }
    if (userAgent.indexOf("Chrome") != -1) {
        map.centerAndZoom(new BMap.Point(116.404, 40.499), 10);
    }

    map.centerAndZoom(new BMap.Point(116.404, 40.499), 10);
    map.addControl(new BMap.NavigationControl({ anchor: BMAP_ANCHOR_BOTTOM_RIGHT }));
    map.addControl(new BMap.MapTypeControl({ anchor: BMAP_ANCHOR_TOP_LEFT }));

    map.enableScrollWheelZoom(true); //开启鼠标滚轮缩放

    map.addEventListener("moveend", G_ShowCurMarkerClusterer);
    map.addEventListener("zoomend", G_ShowCurMarkerClusterer);

    var myDis = new BMapLib.DistanceTool(map);

    var opts = {
        enableMessage: false//设置不允许信息窗发送短息
    };

    function G_ShowCurMarkerClusterer() {
        var bounds = MonitorMap.map.getBounds();
        var markers = MonitorMap.markers;

        //NorthEast
        var max_lat = bounds.getNorthEast().lat;
        var max_lng = bounds.getNorthEast().lng;

        //SouthWest
        var min_lat = bounds.getSouthWest().lat;
        var min_lng = bounds.getSouthWest().lng;

        var mks = new Array();

        if (MonitorMap.markers != null
            && MonitorMap.markers.length > 0) {
            for (var i = 0; i < MonitorMap.markers.length; i++) {
                var mk = MonitorMap.markers[i];
                var lat = mk.BaiduLatitude;
                var lng = mk.BaiduLongitude;

                if (lat > min_lat && lat < max_lat
                    && lng > min_lng && lng < max_lng) {
                    mks.push(mk);
                }
            }
        }

        G_RefreshCarListUI(mks);
    }

    function G_RefreshCarListUI(markers) {
        var panel = $('#MonitorList').html('');
        var panel2 = $('#MonitorList2').html('');

        var startTime = new Date();

        var G_Marker_Cnt = 0;

        for (var i = 0; i < markers.length; i++) {

            var obj_marker = markers[i];

            if (obj_marker.BaiduLatitude != 0
                && obj_marker.BaiduLongitude != 0) {

                G_Marker_Cnt++;

                //创建 li UI对象
                //组织右侧车辆列表
                //++++++++++++++++++++++++++++++++++++++++++++++++++++
                if (G_Marker_Cnt < 100) {
                    CreateUILiFromMarker(i, obj_marker, startTime);
                }
            };
        }
    }

    //创建地图marker及右侧车辆列表
    function G_CreateMarkers(datas) {
        //清空
        map.clearOverlays();
        if (BmarkerClusterer != null) {
            BmarkerClusterer.clearMarkers();
        }

        var panel = $('#MonitorList').html('');
        var panel2 = $('#MonitorList2').html('');

        var startTime = new Date();

        var markers = [];
        var G_Marker_Cnt = 0;

        //全局变量统计离线数量
        G_CarOrTerCount_LX = 0;

        for (var i = 0; i < datas.length; i++) {

            var obj_marker = datas[i];
            var MarkerLXFlag = false;

            if (obj_marker.BaiduLatitude != 0
                && obj_marker.BaiduLongitude != 0) {

                G_Marker_Cnt++;

                //创建 li UI对象
                //组织右侧车辆列表
                //++++++++++++++++++++++++++++++++++++++++++++++++++++
                if (G_Marker_Cnt < 100) {
                    MarkerLXFlag = CreateUILiFromMarker(i, obj_marker, startTime);
                }

                if (MarkerLXFlag) {
                    G_CarOrTerCount_LX++;
                }

                if (obj_marker.Position == null) {
                    obj_marker.Position = "暂无定位位置";
                }

                if (obj_marker.Speed == null) {
                    obj_marker.Speed = "0";
                }

                //组织 marker 提示窗内容
                //++++++++++++++++++++++++++++++++++++++++++++++++++++
                var infoHtml = CreateMarkerPopContent(obj_marker);

                //创建 marker
                //++++++++++++++++++++++++++++++++++++++++++++++++++++
                var marker = CreateMarker(obj_marker);

                markers.push(marker);

                addClickHandler(infoHtml, marker);
            };
        }

        showCarOrTerCount(G_Marker_Cnt);

        BmarkerClusterer = new BMapLib.MarkerClusterer(map, { markers: markers });
    }

    //加载百度地图数据
    function MapViem(datas) {
        if (datas != null && datas.length > 0) {
            G_CreateMarkers(datas);
        }
        else {
            showCarOrTerCount(0);
        }
    };

    //创建右侧车辆列表，单一车辆LI对象,返回 全部/离线 标志量
    function CreateUILiFromMarker(index, obj_marker, startTime) {
        var panel = $('#MonitorList');
        var panel2 = $('#MonitorList2');

        var li = $('<li class="online" data-id="on' + index + '" onclick="SelectCarInfoForId(' + index + ')"></li>');

        li.attr("data_CarNo", obj_marker.CarNo);

        var a = $('<a href="#"></a>')
        var div = $('<div class="img-list"></div>')

        var img = null;

        if (obj_marker.CarId == null) {
            img = $('<img src="../Content/Images/noboundcar.png" width="34" height="34" />');
        }
        else {
            img = $('<img src="../Content/Images/cca1.png" width="34" height="34" />');
        }

        div.append(img);
        a.append(div);

        var span = $('<span></span>')

        //组织文本及tip
        //++++++++++++++++++++++++++++++++++++++++++++++
        BindSpanContent(span, obj_marker);
        //++++++++++++++++++++++++++++++++++++++++++++++

        a.append(span);
        li.append(a);

        a.click(function () {
            $(this).parent().parent().find('a').removeClass('active');
            $(this).addClass('active');
            return true;
        });

        panel.append(li);

        var MarkerLXFlag = GetMarkerLXFlag(obj_marker, startTime);

        if (MarkerLXFlag) {
            var li2 = '<li class="online" onclick="SelectCarInfoForId(' + index + ')">' + li.clone(true).html() + '</li>';
            panel2.append(li2);
        }

        return MarkerLXFlag;
    }

    //创建 marker
    function CreateMarker(obj_marker) {

        var pt = new BMap.Point(obj_marker.BaiduLongitude, obj_marker.BaiduLatitude);

        var marker = new BMap.Marker(pt);

        marker.ObjectId = obj_marker.id;

        return marker;
    }

    //创建 marker tip 内容
    function CreateMarkerPopContent(obj_marker) {

        var infoHtml = new Array();

        if (obj_marker.ProModel == 'Homer3M'
            || obj_marker.ProModel == 'Homer3B-2') {    //有线

            infoHtml.push('<div class="info">');
            infoHtml.push('<h3 class="infowindowheader">' + obj_marker.CarNo + '</h3>');
            infoHtml.push('<table><tr><td>车主姓名：</td><td>' + obj_marker.CarAdminName);
            infoHtml.push('</td></tr><tr><td>终端编号：</td><td>' + obj_marker.TerNo);
            infoHtml.push('</td></tr><tr><td>速度：</td><td>' + obj_marker.Speed);
            infoHtml.push('</td></tr>');

            if (parseFloat(obj_marker.Speed.replace("公里", "")) > 0) {
                infoHtml.push('<tr><td>车辆状态：</td><td>行驶</td></tr>');
            }
            else {
                infoHtml.push('<tr><td>车辆状态：</td><td>停止</td></tr>');
            }

            infoHtml.push('<tr><td>设备状态：</td><td>' + obj_marker.TerStatus);
            infoHtml.push('</td></tr><tr><td>回传时间：</td><td>');
            infoHtml.push(obj_marker.Rtime + '</td></tr><tr><td>地理位置：</td> <td>');
            infoHtml.push(obj_marker.Position + '</td> </tr></table>');
            infoHtml.push('<div class="infowindowfooter"  style="padding:-10px;margin:5px -10px 0px -10px;width:550px;">');

        }
        else {
            infoHtml.push('<div class="info">');
            infoHtml.push('<h3 class="infowindowheader">' + obj_marker.CarNo + '</h3>');
            infoHtml.push('<table ><tr><td>车主姓名：</td><td>' + obj_marker.CarAdminName);
            infoHtml.push('</td></tr><tr><td>终端编号：</td><td>' + obj_marker.TerNo);
            infoHtml.push('</td></tr><tr><td>设备状态：</td><td>' + obj_marker.TerStatus);
            infoHtml.push('</td></tr><tr><td>回传时间：</td><td>' + obj_marker.Rtime);
            infoHtml.push('</td></tr><tr><td>地理位置：</td> <td>' + obj_marker.Position);
            infoHtml.push('</td> </tr></table>');
            infoHtml.push('<div class="infowindowfooter" style="padding:-10px;margin:5px -10px 0px -10px;width:550px;">');
        }

        if (CKXQ == "true") {
            infoHtml.push('<button class="stdbtn btn_lime " type="button" onclick="LookDetail(\'' + obj_marker.CarId + '\',\'' + escape(obj_marker.CarNo) + '\',\'' + obj_marker.TerNo + '\')">查看详情</button>');
        }
        if (CKGJ == "true") {
            infoHtml.push('<button class="stdbtn btn_default" type="button"  onclick="PlayTrack(\'' + obj_marker.CarId + '\',\'' + escape(obj_marker.CarNo) + '\',\'' + obj_marker.TerNo + '\')">历史轨迹</button>');
        }
        if (FSML == "true") {
            infoHtml.push('<button class="stdbtn btn_blue" type="button"  onclick="SendCMD(\'' + escape(obj_marker.CarNo) + '\',\'' + obj_marker.TerNo + '\',\'' + obj_marker.ProName + '\')">发送命令</button>');
        }

        infoHtml.push('<button class="stdbtn btn_blue" type="button"  onclick="RealTrail(\'' + escape(obj_marker.CarNo) + '\',\'' + obj_marker.TerNo + '\')">实时跟踪</button>');

        infoHtml.push('<button class="stdbtn btn_blue" type="button"  onclick="ShowBDRail(\'' + obj_marker.TerNo + '\')">电子围栏</button></div></div>');
        return infoHtml.join("");
    }

    //组织右侧车辆列表文本及tip
    function BindSpanContent($span, cur_marker) {

        //组织文本及tip
        //++++++++++++++++++++++++++++++++++++++++++++++
        ///*
        var span_text = "";
        var span_title = "";
        if (cur_marker.CarAdminName != undefined) {
            span_text += "|" + cur_marker.CarAdminName;
        }
        span_title += "车主：" + (cur_marker.CarAdminName == undefined ? "" : cur_marker.CarAdminName);
        if (cur_marker.CarNo != undefined) {
            span_text += "|" + cur_marker.CarNo;
        }
        span_title += "|车牌号：" + (cur_marker.CarNo == undefined ? "" : cur_marker.CarNo);
        if (cur_marker.TerNo != undefined) {
            span_text += "|" + cur_marker.TerNo;
        }
        span_title += "|终端号：" + (cur_marker.TerNo == undefined ? "" : cur_marker.TerNo);

        if (span_text.length > 0) {
            span_text = span_text.substring(1);
        }

        //$(span).text(span_text);
        //$(span).attr("title", span_title);

        $span.text(span_text);
        $span.attr("title", span_title);

        //*/
        //++++++++++++++++++++++++++++++++++++++++++++++
    }

    //点击列表显示信息窗口
    function SelectCarInfoForId(e) {

        var eventSrc = $("[data-id='on" + e + "']");
        //data_CarNo
        var CarNo = eventSrc.attr("data_CarNo");
        //$("[data-id='on" + e + "']").text();  //获取车辆编号

        if (MonitorMap.markers != null
            && MonitorMap.markers.length > 0) {

            for (var i = 0; i < MonitorMap.markers.length; i++) {

                var obj_marker = MonitorMap.markers[i];

                if (CarNo == obj_marker.CarNo) {

                    if (obj_marker.BaiduLatitude != 0
                        && obj_marker.BaiduLongitude != 0) {

                        var title = obj_marker.CarNo;
                        var url = obj_marker.CarNo;
                        var fileurl = obj_marker.CarNo;

                        if (obj_marker.Position == null) {
                            obj_marker.Position = "暂无定位位置";
                        }

                        var infoHtml = '';
                        if (obj_marker.Speed == null) {
                            obj_marker.Speed = "0";
                        }
                        if (obj_marker.ProModel == 'Homer3M'
                            || obj_marker.ProModel == 'Homer3B-2') {    //有线

                            infoHtml = '<div class="info">'
                            + '<h3 class="infowindowheader">' + obj_marker.CarNo + '</h3>'
                            + '<table><tr><td>车主姓名：</td><td>' + obj_marker.CarAdminName
                            + '</td></tr><tr><td>终端编号：</td><td>' + obj_marker.TerNo
                            + '</td></tr><tr><td>速度：</td><td>' + obj_marker.Speed
                            + '</td></tr>';
                            if (parseFloat(obj_marker.Speed.replace("公里", "")) > 0) {
                                infoHtml += '<tr><td>车辆状态：</td><td>行驶</td></tr>';
                            }
                            else {
                                infoHtml += '<tr><td>车辆状态：</td><td>停止</td></tr>';
                            }
                            var state = obj_marker.ReplydataName == null ? "正常" : obj_marker.ReplydataName;
                            var str = '<tr><td>设备状态：</td><td>' + state
                                + '</td></tr><tr><td>回传时间：</td><td>'
                                + obj_marker.Rtime + '</td></tr><tr><td>地理位置：</td> <td>'
                                + obj_marker.Position + '</td> </tr></table>'
                                + '<div class="infowindowfooter"  style="padding:-10px;margin:5px -10px 0px -10px;width:550px;">';
                            infoHtml += str;
                        }
                        else {
                            infoHtml = '<div class="info">'
                            + '<h3 class="infowindowheader">' + obj_marker.CarNo + '</h3>'
                            + '<table><tr><td>车主姓名：</td><td>' + obj_marker.CarAdminName
                            + '</td></tr><tr><td>终端编号：</td><td>' + obj_marker.TerNo
                            + '</td></tr><tr><td>设备状态：</td><td>' + obj_marker.TerStatus
                            + '</td></tr><tr><td>回传时间：</td><td>' + obj_marker.Rtime
                            + '</td></tr><tr><td>地理位置：</td> <td>' + obj_marker.Position
                            + '</td></tr></table>'
                            + '<div class="infowindowfooter" style="padding:-10px;margin:5px -10px 0px -10px;width:550px;">';
                        }
                        if (CKXQ == "true") {
                            infoHtml += '<button class="stdbtn btn_lime " type="button" onclick="LookDetail(\'' + obj_marker.CarId + '\',\'' + escape(obj_marker.CarNo) + '\',\'' + obj_marker.TerNo + '\')">查看详情</button>';
                        }
                        if (CKGJ == "true") {
                            infoHtml += '<button class="stdbtn btn_default" type="button"  onclick="PlayTrack(\'' + obj_marker.CarId + '\',\'' + escape(obj_marker.CarNo) + '\',\'' + obj_marker.TerNo + '\',\'' + obj_marker.ProName + '\')">历史轨迹</button>';
                        }
                        if (FSML == "true") {
                            infoHtml += '<button class="stdbtn btn_blue" type="button"  onclick="SendCMD(\'' + escape(obj_marker.CarNo) + '\',\'' + obj_marker.TerNo + '\',\'' + obj_marker.ProName + '\')">发送命令</button>';
                        }

                        infoHtml += '<button class="stdbtn btn_blue" type="button"  onclick="RealTrail(\'' + escape(obj_marker.CarNo) + '\',\'' + obj_marker.TerNo + '\')">实时跟踪</button>';

                        infoHtml += '<button class="stdbtn btn_blue" type="button"  onclick="ShowBDRail(\'' + obj_marker.TerNo + '\')">电子围栏</button>'; + '</div>' + '</div>';

                        var pt = new BMap.Point(obj_marker.BaiduLongitude, obj_marker.BaiduLatitude);
                        var infoWindow = new BMap.InfoWindow(infoHtml, pt);  // 创建信息窗口对象

                        map.setCenter(pt);
                        map.openInfoWindow(infoWindow, pt); //开启信息窗口

                        break;
                    }
                }
            }
        }
    }

    //百度地图 标记点击事件
    function addClickHandler(sContent, marker) {
        marker.addEventListener("click", function (e) {
            openInfo(sContent, e)
        });
    };

    //信息窗口
    function openInfo(sContent, e) {
        var p = e.target;
        var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
        var infoWindow = new BMap.InfoWindow(sContent, opts);  // 创建信息窗口对象
        map.openInfoWindow(infoWindow, point); //开启信息窗口
    };

    //调用百度地图
    function BaiDuMap() {
        $("#GoogleMap").css({ "background": "#ffffff", "color": "#797070" });
        $("#BaiDuMap").css({ "background": "#0094ff", "color": "#ffffff" });
    }

    //调用谷歌地图
    function GoogleMap() {
        window.location.href = "/CarMonitor/MonitorIndex";
        $("#GoogleMap").css({ "background": "#0094ff", "color": "#ffffff" });
        $("#BaiDuMap").css({ "background": "#ffffff", "color": "#797070" });
    }

    //设置菜单列表
    function setScroll() {
        $("#box-scroll").slimScroll({
            height: '20px',
            position: 'right',
            alwaysVisible: true
        });
    }

    //测距功能  开启测距
    function getDistance() {
        myDis.open();  //开启鼠标测距
    }

    function DisClear() {
        myDis.close();
    }

    $(function () {
        //终端监控
        if (ZDJK == "true") {
            var li = $("<li id='CZDJK'></li>");
            var a = $('<a href="/Terminal/TerminalMonitor" style="font-size:14px;">终端监控</a>');
            $(li).append(a);
            $("#CUL li:eq(0)").after(li);
        }
        if (window.innerHeight != undefined) {
            innerHeight = window.innerHeight;
        }
        else {
            var B = document.body, D = document.documentElement;
            innerHeight = Math.min(D.clientHeight, B.clientHeight);
        }
        $('#moitorContent').height(innerHeight - 111);
        $('#chatmessage').height($('#moitorContent').height() - 30);
        $('#rightpanel').height(innerHeight - 111);
        $('#CarStatu .panel-body').height($('#rightpanel').height() - 158);
        $('#box-scroll').height($('#CarStatu .panel-body').height() - 10);
        $('#box-scroll2').height($('#CarStatu .panel-body').height() - 10);
        $("input, textarea, select").uniform();
        //MapViem(data);
        if ($.browser.msie) {
            $('input:checkbox').click(function () {
                this.blur();
                this.focus();
            });
        };
        $("#mointerCar").change(function () {
            if ($('#mointerCar').attr("checked") == 'checked') {
                count = 15;
                countdown = setInterval(countDown, 1000);
            } else {
                $("#timeReturn").text("");
                clearInterval(countdown);
            }
            function countDown() {
                $("#timeReturn").text(+count + " 秒后刷新...");
                if (count == 0) {
                    count = 16;
                    if (MapType == "AllCar") {
                        Reflash();
                    } else if (MapType == "CXWarning") {
                        GetWarningListByDept("4", "", "false");
                    }
                    else if (MapType == "DDWarning") {
                        GetWarningListByDept("", "020307", "false");
                    }
                    else if (MapType == "QYWarning") {
                        GetWarningListByDept("", "301", "false");
                    }
                }
                count--;
            }
        });
        target.loadingOverlay();
        $.post("/CarMonitor/GetList", { Businessdivisionid: "@ViewBag.Deptid", SelType: "Dept", RowNumber: 1 }, function (e) {
            target.loadingOverlay('remove');
            if (e != "" && e != "[]") {
                var data = eval(e);
                MonitorMap.markers = data;
                MapViem(data);
                LoadDataTable(data);
            }
            else {
                $("#MonitorList").html("<h3>该企业下没有车</h3>");
            }
        })
        $("#fullscreen").toggle(function () {
            $("#chatmessage").addClass('fulldiv');
            $('#chatmessage').height(window.innerHeight);
            $('#fullscreen').text('缩回');
            document.body.style.overflow = 'hidden';
            $(".intoList").css('display', 'none');
        }, function () {
            $('#fullscreen').text('全屏');
            $("#chatmessage").removeClass('fulldiv');
            $('#chatmessage').height($('#moitorContent').height() - 30);
            document.body.style.overflow = 'scroll';
            $(".intoList").css('display', 'block');
        })
        $("#DeptSel").combotree({
            url: '/Dept/GetOrgNode',
            queryParams: { isTree: "false" },
            animate: true,
            lines: true,
            editable: true,
            onClick: function (node) {
                if (node.id != "") {
                    GetListByDept(node.id);
                    //if (node.code.length <= 8) {
                    //    $("#ShowChild").hide();
                    //}
                    //else {
                    //    $("#ShowChild").show();
                    //}
                }
            },
            onLoadSuccess: function () {
                $('#DeptSel').combotree('setValue', '@ViewBag.Deptid');
                @*var deptcode = '@ViewBag.Deptcode';
                if (deptcode.length <= 8) {
                    $("#ShowChild").hide();
                }
                else {
                    $("#ShowChild").show();
                }*@
            }
        });
        $("#showPanelBtn").onclick = showPanel;

        $("#ShowAll").change(function () {
            $("#MonitorList").html('');
            $("#MonitorList2").html('');
            $("#ListData").html('');
            var DCode = "";
            if ($("#ShowAll").is(':checked') == true) {
                DCode = "true";
            }
            else {
                DCode = "false";
            }
            var DeptId = $('#DeptSel').combotree('getValue');
            if (DeptId != "") {
                target.loadingOverlay();
                $.post("/CarMonitor/GetList", { Businessdivisionid: DeptId, DeptCode: DCode, SelType: "Dept", RowNumber: 1 }, function (e) {
                    target.loadingOverlay('remove');
                    data = eval(e);
                    map.clearOverlays();
                    if (BmarkerClusterer != null) {
                        BmarkerClusterer.clearMarkers();
                    }
                    MapViem(data);
                    CarTable = $('#dyntable').DataTable();
                    CarTable.destroy();
                    LoadDataTable(data);
                    if (e != null && e != "[]") {

                    } else if (e != []) {
                        $("#MonitorList").html("<h3>该企业下没有车</h3>");
                    }
                })
            } else {
                window.parent.$.messager.alert('提示', '请选择企业！', 'info');
            }
        });

        $(".intoList").toggle(function () {
            $("html,body").animate({ scrollTop: $('#dyntable').offset().top }, 300, 'swing');
            $(".intoList").removeClass('down');
            $(".intoList").addClass('up');
        }, function () {
            $("html,body").animate({ scrollTop: $('.topheader').offset().top }, 300, 'swing');
            $(".intoList").removeClass('up');
            $(".intoList").addClass('down');
        });

        BindSearchEvent($(" .textbox-text"), $('#DeptSel'));
        /*
        $(" .textbox-text")
        .attr("title", "输入关键字，点击回车键，进行检索。")
        .bind("input keydown", function (e) {
            if (e.keyCode == "13") {
                $('#DeptSel').combotree('tree').tree("search", $(this).val());
                if ($(this).val() == "" || $(this).val() == null) {
                    $('#DeptSel').combotree('tree').tree("collapseAll");
                }
            }
        });
        */

        $("#DownLoadData").click(function (e) {
            var DeptId = $('#DeptSel').combotree('getValue');
            if ($("#ShowAll").is(':checked') == true) {
                DCode = "true";
            }
            else {
                DCode = "false";
            }
            $.post("../CarMonitor/DownLoadExcel", { Businessdivisionid: DeptId, DeptCode: DCode, SelType: "Dept" }, function (e) {
                if (e.indexOf("Files") > 0) {
                    window.location.href = e;
                } else {
                    window.parent.$.messager.alert('提示', '导出失败，请重新导出！', 'info');
                }
            })
        })
        WarningCX();
        WarningDD();
        WarningQY();
        $('#AllCar').click(function () {
            GetListByDept($('#DeptSel').combotree('getValue'));
        });

        //拆除报警
        $('#showPanelCX').click(function () {
            MapType = "CXWarning";
            GetWarningListByDept("4", "", "true");
            WarningCX();
        });

        //逾期报警
        $('#showPanelYQ').click(function () {
            $(this).find('span').hide();
        })

        //断电报警
        $('#showPanelDD').click(function () {
            MapType = "DDWarning";
            GetWarningListByDept("", "020307", "true");
            WarningDD();
        });

        //区域报警
        $('#showPanelQY').click(function () {
            MapType = "QYWarning";
            GetWarningListByDept("", "301", "true");
            WarningQY();
        });

        $("#Location").change(function () {
            if ($('#Location').attr("checked") == 'checked') {
                getDistance();
            } else {
                DisClear();
            }
        });
    });

    //增减显示数目
    function AddShowCar() {
        RowNumber++;
        $("#MonitorList").html('');
        $("#MonitorList2").html('');
        map.clearOverlays();
        if (BmarkerClusterer != null) {
            BmarkerClusterer.clearMarkers();
        }
        //if (data.length % 20 != 0 || data.length + 20 < RowNumber * 20) {
        //    window.parent.$.messager.alert('提示', '已无更多数据！', 'info');
        //    return;
        //}
        //alert(data.length);
        if (RowNumber > 10) {
            window.parent.$.messager.alert('提示', '加载数据量大,请精确查找！', 'info');
            RowNumber = 10;
        }
        if (SearchFlag == 0) {
            var DCode = "";
            if ($("#ShowAll").is(':checked') == true) {
                DCode = "true";
            }
            else {
                DCode = "false";
            }
            var DeptId = $('#DeptSel').combotree('getValue');
            if (DeptId != "") {
                target.loadingOverlay();
                $.post("/CarMonitor/GetList", { Businessdivisionid: DeptId, DeptCode: DCode, SelType: "Dept", RowNumber: RowNumber }, function (e) {
                    target.loadingOverlay('remove');
                    var data = eval(e);
                    MonitorMap.markers = data;
                    MapViem(data);
                    CarTable = $('#dyntable').DataTable();
                    CarTable.destroy();
                    LoadDataTable(data);
                    if (e != null && e != "[]") {

                    }
                    else if (e != []) {
                        $("#MonitorList").html("<h3>该企业下没有车</h3>");
                    }
                })
            } else {
                window.parent.$.messager.alert('提示', '请选择企业！', 'info');
            }
        }
        else if (SearchFlag == 1) {
            var SelType = "";
            var CarNo = "";
            var TerNo = "";
            var ShowChild = "true";
            if (SearchValue == "") {
                ShowChild = "false";
                SelType = "Dept";
                $('#DeptSel').combotree('setValue', '@ViewBag.Deptid');
                var deptcode = '@ViewBag.Deptcode';
                if (deptcode.length <= 8) {
                    $("#ShowChild").hide();
                }
                else {
                    $("#ShowChild").show();
                }
            }
            else {
                if (SearchName == "CarNo") {
                    CarNo = SearchValue;
                    SelType = "Car";
                } else if (SearchName == "TerNo") {
                    TerNo = SearchValue;
                    SelType = "Ter";
                }
            }
            target.loadingOverlay();
            $.post("/CarMonitor/GetList", { CarNo: CarNo, TerNo: TerNo, DeptCode: ShowChild, SelType: SelType, RowNumber: RowNumber }, function (e) {
                target.loadingOverlay('remove');
                if (e != null && e != "[]") {
                    //data = eval(e);
                    var data = eval(e);
                    MonitorMap.markers = data;
                    MapViem(data);
                    CarTable = $('#dyntable').DataTable();
                    CarTable.destroy();
                    LoadDataTable(data);
                } else if (e == "[]") {
                    data = eval(e);
                    MonitorMap.init(data);
                    $("#MonitorList").html("<h3>没有此车或终端</h3>");
                }
            });
        }
    }

    //拆除报警
    function WarningCX() {
        var DeptId = $('#DeptSel').combotree('getValue');
        if ($("#ShowAll").is(':checked') == true) {
            DCode = "true";
        }
        else {
            DCode = "false";
        }
        $.ajax({
            url: "/CarMonitor/GetCXWaringCount",
            data: { Businessdivisionid: DeptId, Businessdivisioncode: DCode },
            type: "POST",
            success: function (data) {
                $('#showPanelCX').find('span').html(data);
                window.setTimeout("WarningCX()", 60000);
            },
            error: function (data) {
                window.setTimeout("WarningCX()", 60000);
            }
        })
    }

    //断电报警
    function WarningDD() {
        var DeptId = $('#DeptSel').combotree('getValue');
        if ($("#ShowAll").is(':checked') == true) {
            DCode = "true";
        }
        else {
            DCode = "false";
        }
        $.ajax({
            url: "/CarMonitor/GetDDWaringCount",
            data: { Businessdivisionid: DeptId, Businessdivisioncode: DCode },
            type: "POST",
            success: function (data) {
                $('#showPanelDD').find('span').html(data);
                window.setTimeout("WarningDD()", 60000);
            }, error: function (data) {
                window.setTimeout("WarningDD()", 60000);
            }
        })
    }
    //区域报警
    function WarningQY() {
        var DeptId = $('#DeptSel').combotree('getValue');
        if ($("#ShowAll").is(':checked') == true) {
            DCode = "true";
        }
        else {
            DCode = "false";
        }
        $.ajax({
            url: "/CarMonitor/GetQYWaringCount",
            data: { Businessdivisionid: DeptId, Businessdivisioncode: DCode },
            type: "POST",
            success: function (data) {
                $('#showPanelQY').find('span').html(data);
                window.setTimeout("WarningQY()", 60000);
            }, error: function (data) {
                window.setTimeout("WarningQY()", 60000);
            }
        })
    }
    //历史轨迹
    function PlayTrack(CarId, CarNo, TerNo, ProName) {
        if (ProName == "Homer3M" || ProName == "Homer3B-2") {
            window.parent.$.DialogOpen('/HistoryTrail/BDYXTrailNewIndex?CarId=' + CarId + '&TerNo=' + TerNo, { title: '' + unescape(CarNo) + '的轨迹', width: '95%', height: '98%' });
        }
        else {
            window.parent.$.DialogOpen('/HistoryTrail/BDTrailNewIndex?CarId=' + CarId + '&TerNo=' + TerNo, { title: '' + unescape(CarNo) + '的轨迹', width: '95%', height: '98%' });
        }
    }
    //查看详情
    function LookDetail(CarId, CarNo, TerNo) {
        window.parent.$.DialogOpen('/CarDetail/Index?CarId=' + CarId + '&TerNo=' + TerNo, { title: '' + unescape(CarNo) + '的详情', width: 750, height: 450 })
    }
    //发送命令
    function SendCMD(CarNo, TerNo, ProName) {
        if (ProName == "一代无线GPS") {
            window.parent.$.DialogOpen('/SendCMD/DevSendCMD?str=' + TerNo, { title: unescape(CarNo), width: 880, height: 500 })
        }
        else if (ProName == "二代无线GPS") {
            window.parent.$.DialogOpen('/SendCMD/DevSendCMD_New?str=' + TerNo, { title: unescape(CarNo), width: 900, height: 500 })
        }
        else if (ProName == "Homer3M") {
            window.parent.$.DialogOpen('/SendCMD/WiredDevCMD?str=' + TerNo + '&flag=true', { title: TerNo, width: 860, height: 500 });
        }
        else if (ProName == "Homer3B-2") {
            window.parent.$.DialogOpen('/SendCMD/WiredDevCMD?str=' + TerNo + '&flag=true', { title: TerNo, width: 860, height: 500 });
        }
        else {

        }
    }
    //实时跟踪
    function RealTrail(CarNo, TerNo) {
        window.open('/HistoryTrail/BDRealTrail?TerNo=' + TerNo + '&CarNo=' + unescape(CarNo));
    }

    //电子围栏
    function ShowBDRail(TerNo) {
        window.parent.$.DialogOpen('/RailManager/BDRailView?TerNo=' + TerNo, { title: '电子围栏', width: 900, height: 600 });
    }

    //实时车辆
    function GetListByDept(DeptId) {
        $("#MonitorList").html('');
        $("#MonitorList2").html('');
        $("#ListData").html('');
        map.clearOverlays();
        if (BmarkerClusterer != null) {
            BmarkerClusterer.clearMarkers();
        }
        var DCode = "";
        if ($("#ShowAll").is(':checked') == true) {
            DCode = "true";
        }
        else {
            DCode = "false";
        }
        target.loadingOverlay();
        $.post("/CarMonitor/GetList", { Businessdivisionid: DeptId, DeptCode: DCode, SelType: "Dept", RowNumber: 1 }, function (e) {
            target.loadingOverlay('remove');
            //data = eval(e);
            var data = eval(e);
            MonitorMap.markers = data;
            MapViem(data);
            CarTable = $('#dyntable').DataTable();
            CarTable.destroy();
            LoadDataTable(data);
            if (e != null && e != "[]") {

            } else if (e == "[]") {
                $("#MonitorList").html("<h3>该企业下没有车</h3>");
            }
        })
    }

    //页面刷新(TerStatus:报警类型，ReplydataCode 报警代码,linkType(true:手动访问，false:自动访问))
    function GetWarningListByDept(TerStatus, ReplydataCode, linkType) {
        var DeptId = $('#DeptSel').combotree('getValue');
        $("#MonitorList").html('');
        $("#MonitorList2").html('');
        $("#ListData").html('');
        var DCode = "";
        if ($("#ShowAll").is(':checked') == true) {
            DCode = "true";
        }
        else {
            DCode = "false";
        }
        if (linkType == "true") {
            target.loadingOverlay();
        }
        $.post("/CarMonitor/GetList", { Businessdivisionid: DeptId, DeptCode: DCode, TerStatus: TerStatus, ReplydataCode: ReplydataCode, SelType: "Dept", RowNumber: 1 }, function (e) {
            if (linkType == "true") {
                target.loadingOverlay('remove');
            }
            //data = eval(e);
            //debugger;
            var data = eval(e);
            MonitorMap.markers = data;
            map.clearOverlays();
            if (BmarkerClusterer != null) {
                BmarkerClusterer.clearMarkers();
            }
            MapViem(data);
            CarTable = $('#dyntable').DataTable();
            CarTable.destroy();
            LoadDataTable(data);
            if (e == "[]") {
                $("#MonitorList").html("<h3>该企业下无报警车辆</h3>");
            }
        })
    }

    //地图刷新
    function Reflash() {
        var DeptId = $('#DeptSel').combotree('getValue');
        $("#MonitorList").html('');
        $("#MonitorList2").html('');
        $("#ListData").html('');
        var DCode = "";
        if ($("#ShowAll").is(':checked') == true) {
            DCode = "true";
        }
        else {
            DCode = "false";
        }
        $.post("/CarMonitor/GetList", { Businessdivisionid: DeptId, DeptCode: DCode, SelType: "Dept", RowNumber: RowNumber }, function (e) {
            //data = eval(e);
            var data = eval(e);
            MonitorMap.markers = data;
            map.clearOverlays();
            if (BmarkerClusterer != null) {
                BmarkerClusterer.clearMarkers();
            }
            MapViem(data);
            CarTable = $('#dyntable').DataTable();
            CarTable.destroy();
            LoadDataTable(data);
            if (e != null && e != "[]") {

            } else if (e == "[]") {
                $("#MonitorList").html("<h3>该企业下没有车</h3>");
            }
        })
    }
    //搜索 carno terno
    function doSearch(value, name) {
        $("#MonitorList").html('');
        $("#MonitorList2").html('');
        $("#ListData").html('');
        map.clearOverlays();
        SearchFlag = 1;
        SearchValue = value;
        SearchName = name;
        var SelType = "";
        var CarNo = "";
        var TerNo = "";
        var ShowChild = "true";
        if (value == "") {
            ShowChild = "false";
            SelType = "Dept";
            $('#DeptSel').combotree('setValue', '@ViewBag.Deptid');
            var deptcode = '@ViewBag.Deptcode';
            if (deptcode.length <= 8) {
                $("#ShowChild").hide();
            }
            else {
                $("#ShowChild").show();
            }
            initmap();
        }
        else {
            if (name == "CarNo") {
                CarNo = value;
                SelType = "Car";
            } else if (name == "TerNo") {
                TerNo = value;
                SelType = "Ter";
            }
        }
        target.loadingOverlay();
        $.post("/CarMonitor/GetList", { CarNo: CarNo, TerNo: TerNo, DeptCode: ShowChild, SelType: SelType, RowNumber: 1 }, function (e) {
            target.loadingOverlay('remove');
            map.clearOverlays();
            if (BmarkerClusterer != null) {
                BmarkerClusterer.clearMarkers();
            }
            if (e != null && e != "[]") {
                //data = eval(e);
                var data = eval(e);
                MonitorMap.markers = data;
                MapViem(data);
                CarTable = $('#dyntable').DataTable();
                CarTable.destroy();
                LoadDataTable(data);
            } else if (e == "[]") {
                //data = eval(e);
                var data = eval(e);
                MonitorMap.markers = data;
                MapViem(data);
                $("#MonitorList").html("<h3>没有此车或终端</h3>");
            }
        });
        //console.info(data[0]);
    }
    //显示结果面板动作
    function showPanel() {
        if (isPanelShow == false) {
            isPanelShow = true;
            $("showPanelBtn").style.right = "230px";
            $("panelWrap").style.height = "230px";
        } else {
            isPanelShow = false;
            $("showPanelBtn").style.right = "0px";
            $("panelWrap").style.height = "0px";
        }
    }
    function LoadDataTable(data) {
        CarTable = $('#dyntable').dataTable({
            language: {
                "lengthMenu": "每页 _MENU_ 条记录",
                "zeroRecords": "没有找到记录",
                "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 ) 共_TOTAL_条",
                "infoEmpty": "无记录",
                "infoFiltered": "(从 _MAX_ 条记录过滤)",
                "search": "模糊查询"
            },
            initComplete: function () {
                $("#mytool").append('<button id="datainit" type="button" class="btn btn-primary btn-sm">导出数据</button>&nbsp');
            },
            data: data,
            columns: [
                { "data": "Rtime" },
                { "data": "CarNo" },
                { "data": "TerNo" },
                { "data": "TerStatus" },
                { "data": "Ifposition" },
                { "data": "Position" },
                { "data": "TerSimcard" },
                { "data": "Businessdivisionname" },
                { "data": "Postbacktimes" }
            ],
            "columnDefs": [{
                targets: [0],
                orderData: [0, 1]  //如果第一列进行排序，有相同数据则按照第二列顺序排列
            }, {
                targets: [1],
                orderData: [1, 0]  //如果第二列进行排序，有相同数据则按照第一列顺序排列
            }, {
                targets: [4],
                orderData: [4, 0]  //如果第五列进行排序，有相同数据则按照第一列顺序排列
            }],
            lengthChange: true,
            pageLength: 10,
            scrollCollapse: true,
            pagingType: "full_numbers",
            scrollX: true,
            ordering: true
        });
    }
    window.onresize = function () {
        $('#moitorContent').height(innerHeight - 111);
        $('#chatmessage').height($('#moitorContent').height() - 30);
        $('#rightpanel').height(innerHeight - 111);
        $('#CarStatu .panel-body').height($('#rightpanel').height() - 158);
        $('#box-scroll').height($('#CarStatu .panel-body').height() - 10);
        $('#box-scroll2').height($('#CarStatu .panel-body').height() - 10);
    }
</script>

<style>
    #MapContainer {
        position: absolute;
        width: 150px;
        height: 21px;
        background: #fff;
        opacity: 0.9;
        z-index: 1;
        top: 13px;
        right: 200px;
        border: 1px solid #999;
    }

        #MapContainer div {
            width: 75px;
            float: left;
            text-align: center;
        }

    #BaiDuMap {
        cursor: pointer;
        color: #fff;
        background: #0094ff;
    }

    #GoogleMap {
        cursor: pointer;
        background: #ffffff;
        color: #797070;
    }
</style>